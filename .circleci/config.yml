version: 2
jobs:
  build:
    docker:
     - image: codenvy/che-dev:latest
    working_directory: /home/user/che-build
    steps:
     - checkout
     - restore_cache:
         keys:
           - m2
     - run:
         name: Maven build
         command: mvn clean install 2>&1 | grep -v -e "Download" -e " KB"
     - save_cache:
         key: m2
         paths:
           - ~/.m2/repository
     - run:
         name: Install Docker
         command: |
           set -x
           VER="17.03.0-ce"
           curl -L -o /tmp/docker-$VER.tgz https://get.docker.com/builds/Linux/x86_64/docker-$VER.tgz
           tar -xz -C /tmp -f /tmp/docker-$VER.tgz
           sudo mv /tmp/docker/* /usr/bin
     - setup_remote_docker
     - run: |
         name: Build images
         command: |
           dockerfiles/cli/build.sh
           dockerfiles/init/build.sh
           dockerfiles/server/build.sh
     - run:
         name: Push images
         command: |
           docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
           docker push convertigo/convertigo-che-cli:nightly
           docker push convertigo/convertigo-che-init:nightly
           docker push convertigo/convertigo-che-server:nightly
